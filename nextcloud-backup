#!/bin/bash

## Variables ##
scriptdir=$(dirname $0)
scriptname=$(basename $0)
D="-------"
testmode="no"
database="no"
folder="no"
maintmode="no"
bkpdate=$(date +"%Y%m%d")

## Parameters ##
if [ -f ${scriptdir}/${scriptname}.conf ] ; then
	. ${scriptdir}/${scriptname}.conf
else
	echo -e "ERROR: Parameter file (${scriptdir}/${scriptname}.conf) not found!"
fi

## Functions ##
# Script usage #
usage()
{
	echo -e "Usage: ${scriptname} [-d] [-f] [-m] [-t]" 1>&2
	echo -e " -d: dumping the nextcloud database"
	echo -e " -f: archiving the nextcloud folder"
	echo -e " -m: setting maintenance mode on before backup and off after"
	echo -e " -t: running in testmode (simulating the backup)"
}

# Print to log #
print_log()
{
	delimiter="----------------$D-----------------------"
	logstamp="----- Backup $1: $(date +'%Y-%m-%d') $(date +'%H-%M-%S') -----"
	case $1 in
		start)	echo -e "\n$delimiter\n$logstamp" >>$bkplog ;;
		end)	echo -e "\n$logstamp\n$delimiter\n" >>$bkplog ;;
	esac
}

# Setting maintenance mode on Nextcloud instance #
maint_mode()
{
	mode=$(printf '%s\n' "$1" | awk '{ print toupper($0) }')
	echo -e "\n[INFO] Maintenance mode $mode" >>$bkplog
	if [ "$testmode" == "no"  ] ; then
		sudo -u www-data php $ncdir/occ maintenance:mode --$1 >>$bkplog 2>&1
		if [ $? -ne 0 ] ; then
			echo -e "[ERROR] Setting maintenance mode '$mode' failed (exit code: $?)" >>$bkplog
			exit 1
		else
			echo -e "[OK] Setting maintenance mode '$mode' succeeded" >>$bkplog
		fi
	fi
}

# MySQL database export #
db_dump()
{
	echo -e "\n[INFO] DataBase Export" >>$bkplog
	if [ "$testmode" == "no"  ] ; then
		mysqldump --single-transaction -h "$dbhost" -P "$dbport" -u "$dbuser" -p"$dbpwd" "$dbname" > $bkpdst/nextcloud-sqlbkp_$bkpdate.sql 2>>$bkplog
		if [ $? -ne 0 ] ; then
			echo -e "[ERROR] DataBase export failed (exit code: $?)" >>$bkplog
			exit 1
		else
			ls -l $bkpdst/nextcloud-sqlbkp_$bkpdate.sql | awk -F " " '{print $5,$9}' >>$bkplog
			echo -e "[OK] DataBase export succeeded" >>$bkplog
		fi
	fi
}

# Folder archival #
folder_archive()
{
	echo -e "\n[INFO] Folder archival" >>$bkplog
	if [ "$testmode" == "no" ] ; then
		tar -czf $bkpdst/nextcloud-dirbkp_$bkpdate.tgz --directory="$ncdir" --exclude="$direxcl" . 2>>$bkplog
		if [ $? -ne 0 ] ; then
			echo -e "[ERROR] Folder archive failed (exit code: $?)" >>$bkplog
			exit 1
		else
			ls -l $bkpdst/nextcloud-dirbkp_$bkpdate.tgz | awk -F " " '{print $5,$9}' >>$bkplog
			echo -e "[OK] Folder archive succeeded" >>$bkplog
		fi
	fi
}

## Main ##
while getopts ":dfmt" option
do
	case $option in
		d)	database="yes" ;;
		f)	folder="yes" ;;
		m)	maintmode="yes" ;;	
		t)	testmode="yes" ; D="DRY-RUN" ;;
		*)
			echo -e "$OPTARG: invalid option\n"
			usage
			exit 2
			;;
	esac
done

print_log start
if [ "$maintmode" == "yes" ] ; then maint_mode on ; fi
if [ "$database" == "yes" ] ; then db_dump ; fi
if [ "$folder" == "yes" ] ; then folder_archive ; fi
if [ "$maintmode" == "yes" ] ; then maint_mode off ; fi
print_log end
exit 0
