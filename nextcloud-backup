#!/bin/bash

## Variables ##
dryrun="no"
D="-------"
bkpdate=$(date +"%Y%m%d")
bkplog="/var/log/backups/$bkpdate.log"
bkpdst="/mnt/backups"
ncdir="/srv/www/nextcloud"
direxcl="*/data/updater-*"
dbhost=$(grep dbhost $ncdir/config/config.php | awk -F "'" '{print $4}' | awk -F ":" '{print $1}')
dbport=$(grep dbhost $ncdir/config/config.php | awk -F "'" '{print $4}' | awk -F ":" '{print $2}')
dbuser=$(grep dbuser $ncdir/config/config.php | awk -F "'" '{print $4}')
dbpwd=$(grep dbpassword $ncdir/config/config.php | awk -F "'" '{print $4}')
dbname=$(grep dbname $ncdir/config/config.php | awk -F "'" '{print $4}')

## Functions ##
# Script usage #
usage()
{
	scriptname=$(basename $0)
	echo -e "Usage: $scriptname [-d]" 1>&2
	echo -e " -d: dry-run"
	exit 1
}

# Print to log #
print_log()
{
	delimiter="----------------$D-----------------------"
	logstamp="----- Backup $1: $(date +'%Y-%m-%d') $(date +'%H-%M-%S') -----"
	case $1 in
		start)
			echo -e "\n$delimiter\n$logstamp" >>$bkplog
			;;
		end)
			echo -e "\n$logstamp\n$delimiter\n" >>$bkplog
	esac
}

# Setting maintenance mode on Nextcloud instance #
maint_mode()
{
	mode=$(printf '%s\n' "$1" | awk '{ print toupper($0) }')
	echo -e "\n--- Maintenance mode $mode ---" >>$bkplog
	if [ "$dryrun" == "no"  ] ; then
		sudo -u www-data php $ncdir/occ maintenance:mode --$1 >>$bkplog 2>&1
		if [ $? -ne 0 ] ; then
			echo -e "-> Setting maintenance mode '$mode': Failed! (exit code: $?)" >>$bkplog
			exit 1
		else
			echo -e "-> Setting maintenance mode '$mode': OK" >>$bkplog
		fi
	fi
}

# MySQL database export #
db_dump()
{
	echo -e "\n--- DataBase Export ---" >>$bkplog
	if [ "$dryrun" == "no"  ] ; then
		mysqldump --single-transaction -h "$dbhost" -P "$dbport" -u "$dbuser" -p"$dbpwd" "$dbname" > $bkpdst/nextcloud-sqlbkp_$bkpdate.sql 2>>$bkplog
		if [ $? -ne 0 ] ; then
			echo -e "-> DataBase export: Failed! (exit code: $?)" >>$bkplog
			exit 1
		else
			ls -l $bkpdst/nextcloud-sqlbkp_$bkpdate.sql | awk -F " " '{print $5,$9}' >>$bkplog
			echo -e "-> DataBase export: OK" >>$bkplog
		fi
	fi
}

# Folder archival #
folder_archive()
{
	echo -e "\n--- Folder archival ---" >>$bkplog
	if [ "$dryrun" == "no" ] ; then
		tar -czf $bkpdst/nextcloud-dirbkp_$bkpdate.tgz --directory="$ncdir" --exclude="$direxcl" . 2>>$bkplog
		if [ $? -ne 0 ] ; then
			echo -e "-> Folder archive: Failed! (exit code: $?)" >>$bkplog
			exit 1
		else
			ls -l $bkpdst/nextcloud-dirbkp_$bkpdate.tgz | awk -F " " '{print $5,$9}' >>$bkplog
			echo -e "-> Folder archive: OK" >>$bkplog
		fi
	fi
}

## Main ##
while getopts ":d" option
do
	case $option in
		d)
			dryrun="yes"
			D="DRY-RUN"
			;;
		*)
			echo -e "$OPTARG: invalid option\n"
			usage
			;;
	esac
done

print_log start
maint_mode on
db_dump
folder_archive
maint_mode off
print_log end
exit 0
